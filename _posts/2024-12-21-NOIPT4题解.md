---
layout: post
title: "NOIP2024 T4 题解"
date:   2024-6-21
tags: [树状数组, cdq分治]
comments: true
author: Targanzqq
---
新号第一篇题解。
### 定理 $1$：

$dep(LCA(l,r))=\min_{i=l}^{r-1}dep(lca(i,i+1))$

证明：钦定 $dep(LCA(l,r))$ 的当前贡献元素为 $l,r$，若贡献不增加则有 $lca(l+1,r)=lca(l,r)$ 或 $lca(l+1,l)=lca(l,r)$，因为点 $l+1$ 只可能与 $l$ 或 $r$ 至多其中之一在同一子树中。因此我们可以将贡献元素转移到 $l+1,r$。

### 定理 $2$：

$\sum_{i=k}^{r-l+1}\max_{j=l}^{l+i-1}dep(LCA(l,r))=\max_{i=l}^{r-k+1}dep(LCA(i,i+k-1))$

证明：我们根据定理 $1$ 证明过程反向扩展，深度显然单调不增，因此长度为 $k$ 时一定最优。

### 做法：
定义点 $i$ 的“影响区间”为以一个包含所有以 $lca(i,i+1)$ 为答案的区间的最小区间。树状数组前后跑一遍即可处理。时间复杂度 $O(n\log n)$。

我们尝试转化问题：如果一个点可以作为当前询问的备选答案之一，那么需要满足其影响区间在当前询问区间内的长度至少为 $k$。对于影响区间 $L_i,R_i$ 分类讨论：

若 $R_i>r$，需要满足 $L_i\le r-k+1$，对于这两个贡献显然可以使用二维偏序进行求解，可以直接 $cdq$ 分治。

若 $l+k-1<R_i\le R$，需要满足 $R_i-L_i+1\ge k$，我们可以考虑对点构造 $(R_i-L_i+1,R_i,R_i)$，对询问构造 $(k,l+k-1,r)$ 进行三维偏序求解，需要 $cdq$ 分治和树状数组一起使用。

以上两个偏序问题需要维护最小值而不是求和。时间复杂度 $O(n\log^2n)$。

### 偏序问题的求解
偏序问题是形如“对于点 $i$，统计 $\forall j,a_{k_j,i}\prec a_{k_j,i'}$ 相关答案的问题。其中 $k$ 表示维度。

第一维可以直接排序，如果没有第三维，则通过排序算法，将底层分治序列排好序后进行跨分治序列的答案统计，可以使用双指针。如果有第三维，可以使用树状数组对第三维进行限制性的统计。

在这个题目中，我们要对于一些无关点统计有关点的答案，那么我们可以将询问构造为一个无贡献的点，使得这些点在被统计贡献的时候不会被影响，且用到这些点统计到的贡献的答案。这样我们可以用相同级别的冗余计算来获得答案。
